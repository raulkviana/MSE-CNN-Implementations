<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MSE-CNN Implementation: Code to process the images/videos into labels</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MSE-CNN Implementation<span id="projectnumber">&#160;1</span>
   </div>
   <div id="projectbrief">Code database with the implementation of MSE-CNN, from the paper &#39;DeepQTMT: A Deep Learning Approach for Fast QTMT-based CU Partition of Intra-mode VVC&#39;</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Code to process the images/videos into labels</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md33"></a>All of the code bellow can be found in this <a href="../../../src/msecnn_raulkviana/useful_scripts">folder</a>.</p>
<h2><a class="anchor" id="autotoc_md34"></a>
Encoding</h2>
<div class="fragment"><div class="line"> python</div>
<div class="line">import dataset_utils</div>
<div class="line"> </div>
<div class="line"># Quantization parameter</div>
<div class="line">QP = 27</div>
<div class="line"> </div>
<div class="line"># Temporal Subsample Ratio</div>
<div class="line">ts = 500</div>
<div class="line"> </div>
<div class="line"># Directory containing the dataset images</div>
<div class="line">d_path = &quot;path_for_images_or_videos&quot;</div>
<div class="line"> </div>
<div class="line"># Directory containing the .exe file extension to run the encoder.</div>
<div class="line"># It ends with CPIV\VTM-7.0_Data\bin\vs16\msvc-19.24\x86_64\release in Windows</div>
<div class="line">e_path = &quot;path_to_encoder&quot; # Example for windows</div>
<div class="line"> </div>
<div class="line">dataset_utils.encode_dataset(d_path=d_path, e_path=e_path, ts=ts, QP=QP) # The result is saved in the encoder folder</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md35"></a>
Generate data structures</h2>
<div class="fragment"><div class="line"> python</div>
<div class="line">import dataset_utils</div>
<div class="line"> </div>
<div class="line"># Directory containing the .dat files with CUs informations</div>
<div class="line">d_path = &quot;path_of_output_directory_of_the_previous_step&quot;</div>
<div class="line"> </div>
<div class="line">dataset_utils.unite_labels_v6_mod(dir_path_l=d_path, n_output_file=&quot;modifier_of_the_output_files_name&quot;)  # The result is saved in the same folder</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md36"></a>
Add real CTUs</h2>
<div class="fragment"><div class="line"> python</div>
<div class="line">import dataset_utils</div>
<div class="line"> </div>
<div class="line"># Path with the labels processed</div>
<div class="line">path_dir_l = r&quot;path_of_output_directory_of_the_previous_step&quot;  </div>
<div class="line"> </div>
<div class="line"># Path with the pictures</div>
<div class="line">path_dir_p = r&quot;path_for_images_or_videos&quot;</div>
<div class="line"> </div>
<div class="line"># Create new dir to save data</div>
<div class="line">name_mod = &quot;mod_with_real_CTU&quot;</div>
<div class="line">new_dir = path_dir_l + &quot;/&quot; + name_mod + &quot;/&quot;</div>
<div class="line">try:</div>
<div class="line">    os.mkdir(new_dir)</div>
<div class="line">except:</div>
<div class="line">    # Delete the directory</div>
<div class="line">    shutil.rmtree(new_dir)</div>
<div class="line">    # Recreate it</div>
<div class="line">    os.mkdir(new_dir)</div>
<div class="line"> </div>
<div class="line"># Get files names from folder</div>
<div class="line">files_l = dataset_utils.get_files_from_folder(path_dir_l, endswith=&quot;.txt&quot;)</div>
<div class="line"> </div>
<div class="line"># CTU Counter and number of entries to accumulate</div>
<div class="line">ctu_count = 0</div>
<div class="line"> </div>
<div class="line">for f in files_l:</div>
<div class="line">    # Make labels path</div>
<div class="line">    lbls_path = os.path.join(path_dir_l, f)</div>
<div class="line"> </div>
<div class="line">    # List to save entries</div>
<div class="line">    mod_list = []</div>
<div class="line"> </div>
<div class="line">    # Read file</div>
<div class="line">    orig_list = dataset_utils.file2lst(lbls_path[:-4])</div>
<div class="line">    data_size = len(orig_list)</div>
<div class="line">    accum = data_size</div>
<div class="line"> </div>
<div class="line">    # Verbose</div>
<div class="line">    print(&quot;Processing:&quot;, lbls_path)</div>
<div class="line"> </div>
<div class="line">    # Loop entries</div>
<div class="line">    for k in range(len(orig_list)):</div>
<div class="line"> </div>
<div class="line">        # Build all requirements to get the CU</div>
<div class="line">        file_name = orig_list[k][&#39;pic_name&#39;]</div>
<div class="line">        img_path = os.path.join(path_dir_p, file_name + &#39;.yuv&#39;)</div>
<div class="line">        POC = orig_list[k][&#39;POC&#39;]</div>
<div class="line">        f_size = CustomDataset.get_file_size(file_name)  # Dict with the size of the image</div>
<div class="line">        f_size = (f_size[&#39;height&#39;], f_size[&#39;width&#39;])</div>
<div class="line">        cu_pos = (orig_list[k][&quot;stg_1&quot;][&quot;cu_pos&quot;][&quot;CU_loc_top&quot;], orig_list[k][&quot;stg_1&quot;][&quot;cu_pos&quot;][&quot;CU_loc_left&quot;])</div>
<div class="line">        cu_size = (orig_list[k][&quot;stg_1&quot;][&quot;cu_size&quot;][&quot;height&quot;], orig_list[k][&quot;stg_1&quot;][&quot;cu_size&quot;][&quot;width&quot;])</div>
<div class="line"> </div>
<div class="line">        # Verify size of the CU</div>
<div class="line">        if cu_size[0] != 128 or cu_size[1] != 128:</div>
<div class="line">            continue</div>
<div class="line"> </div>
<div class="line">        # Get CU</div>
<div class="line">        frame_CU, CU_Y, CU_U, CU_V = CustomDataset.get_cu(img_path, f_size, cu_pos, cu_size, POC)</div>
<div class="line"> </div>
<div class="line">        # Convert to Pytorch Tensor</div>
<div class="line">        CU_Y = torch.tensor(CU_Y.tolist())</div>
<div class="line"> </div>
<div class="line">        # Convert to type</div>
<div class="line">        CU_Y = CU_Y.to(dtype=torch.float32)</div>
<div class="line"> </div>
<div class="line">        # Add dimension</div>
<div class="line">        CU_Y = torch.unsqueeze(CU_Y, 0)</div>
<div class="line"> </div>
<div class="line">        # Add to entry</div>
<div class="line">        orig_list[k][&quot;stg_1&quot;][&quot;real_CTU&quot;] = CU_Y</div>
<div class="line"> </div>
<div class="line">        # Save entry in final list</div>
<div class="line">        mod_list.append(orig_list[k])</div>
<div class="line"> </div>
<div class="line">        utils.echo(&quot;Complete: {per:.0%}&quot;.format(per=k/data_size))</div>
<div class="line"> </div>
<div class="line">        if (k+1) % accum == 0:</div>
<div class="line">            # Save list to file with the same name</div>
<div class="line">            new_path = os.path.join(new_dir, f[:-4]+str(ctu_count)+ &quot;_&quot; + name_mod)</div>
<div class="line">            dataset_utils.lst2file(mod_list, new_path)</div>
<div class="line"> </div>
<div class="line">            # Reset list</div>
<div class="line">            mod_list = []</div>
<div class="line"> </div>
<div class="line">            # Incremente counter</div>
<div class="line">            ctu_count += 1</div>
<div class="line"> </div>
<div class="line">    if (k - (len(orig_list) - 1)) != 0:  # Verify if there is still entries</div>
<div class="line">        # Save list to file with the same name</div>
<div class="line">        new_path = os.path.join(new_dir, f[:-4] + str(ctu_count) + &quot;_&quot; + name_mod)</div>
<div class="line">        dataset_utils.lst2file(mod_list, new_path)</div>
<div class="line"> </div>
<div class="line">    # Reset counter</div>
<div class="line">    ctu_count = 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md37"></a>
Retrieve essential data</h2>
<p>Retrieve essential data for the for stage 6</p>
<div class="fragment"><div class="line"> python</div>
<div class="line">import dataset_utils</div>
<div class="line"> </div>
<div class="line">path_dir_l = &quot;directory_with_the_output_of_the_previous_step&quot;</div>
<div class="line"> </div>
<div class="line">print(&quot;Modifying struct from:&quot;, path_dir_l)</div>
<div class="line"> </div>
<div class="line">dataset_utils.change_struct_no_dupl_stg_6_complexity_v4(path_dir_l)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md38"></a>
Balacing data</h2>
<div class="fragment"><div class="line"> python</div>
<div class="line">import dataset_utils</div>
<div class="line"> </div>
<div class="line"># Directory containing the .txt files with CUs informations</div>
<div class="line">path_dir_l = &quot;output_of_the_previous_step&quot;  # Path with the labels processed</div>
<div class="line"> </div>
<div class="line">print(&quot;Balance data in:&quot;, path_dir_l)</div>
<div class="line"> </div>
<div class="line">dataset_utils.balance_dataset_down_v3(path_dir_l)  # Downsampling</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7
</small></address>
</body>
</html>
